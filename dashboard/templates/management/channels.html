{% extends "_base.html" %}

{% block title %}Channel Management | Bot Dashboard{% endblock %}

{% block content %}
    <h1>Channel Management</h1>

    <div class="message-box" id="channel-message"></div>

    <div class="row">
        <div class="column column-50">
            <div class="control-group">
                <h4>Create Channel</h4>
                <form id="create-channel-form">
                    <label for="channel_name">Channel Name</label>
                    <input type="text" id="channel_name" name="channel_name" required>
                    
                    <label for="channel_type">Channel Type</label>
                    <select id="channel_type" name="channel_type">
                        <option value="text">Text Channel</option>
                        <option value="voice">Voice Channel</option>
                        <option value="category">Category</option>
                    </select>

                    <label for="category_id">Parent Category (for Text/Voice)</label>
                    <select id="category_id" name="category_id">
                        <option value="">-- None --</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <button class="button-primary" type="submit">Create Channel</button>
                </form>
            </div>
        </div>
        <div class="column column-50">
            <div class="control-group">
                <h4>Delete Channel</h4>
                <form id="delete-channel-form">
                    <label for="delete_channel_id">Select Channel to Delete</label>
                    <select id="delete_channel_id" name="channel_id" required>
                        <option value="">-- Select Channel --</option>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}">{{ channel.name }} ({{ channel.type }})</option>
                        {% endfor %}
                    </select>
                    <button class="button-outline" type="submit">Delete Channel</button>
                </form>
            </div>
        </div>
    </div>

    <h2>Existing Channels</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Type</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody id="channels-list">
            {% for channel in channels %}
            <tr>
                <td>{{ channel.id }}</td>
                <td>{{ channel.name }}</td>
                <td>{{ channel.type }}</td>
                <td>{{ channel.category }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block scripts %}
<script>
    // Message box helper
    function showMessage(type, message, boxId = 'channel-message') {
        const msgBox = document.getElementById(boxId);
        msgBox.className = `message-box ${type} show`;
        msgBox.textContent = message;
        setTimeout(() => msgBox.classList.remove('show'), 5000); // Hide after 5 seconds
    }

    // Function to refresh channel list (for dynamic updates after actions)
    async function refreshChannelList() {
        const response = await fetch('/manage/channels'); // Fetch the full page HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(await response.text(), 'text/html');
        
        // Extract updated list and categories
        const newChannelsList = doc.getElementById('channels-list').innerHTML;
        const newCategoriesOptions = doc.getElementById('category_id').innerHTML;
        const newDeleteChannelsOptions = doc.getElementById('delete_channel_id').innerHTML;

        // Update current page elements
        document.getElementById('channels-list').innerHTML = newChannelsList;
        document.getElementById('category_id').innerHTML = newCategoriesOptions;
        document.getElementById('delete_channel_id').innerHTML = newDeleteChannelsOptions;
    }

    // Create Channel Form
    document.getElementById('create-channel-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        try {
            const response = await fetch('/api/channels/create', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showMessage('success', result.message);
                this.reset(); // Clear form
                await refreshChannelList();
            } else {
                showMessage('error', result.detail || 'Failed to create channel.');
            }
        } catch (error) {
            showMessage('error', 'An error occurred: ' + error.message);
        }
    });

    // Delete Channel Form
    document.getElementById('delete-channel-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const confirmDelete = confirm("Are you sure you want to delete this channel?");
        if (!confirmDelete) return;

        try {
            const response = await fetch('/api/channels/delete', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (response.ok) {
                showMessage('success', result.message);
                this.reset();
                await refreshChannelList();
            } else {
                showMessage('error', result.detail || 'Failed to delete channel.');
            }
        } catch (error) {
            showMessage('error', 'An error occurred: ' + error.message);
        }
    });
</script>
{% endblock %}